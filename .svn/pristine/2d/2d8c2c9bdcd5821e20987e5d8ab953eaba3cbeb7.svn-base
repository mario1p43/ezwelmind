package com.ezwel.admin.controller.partner.mgr;

import java.util.Iterator;
import java.util.Set;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.multipart.MultipartHttpServletRequest;

import com.ezwel.admin.common.support.bean.EncryptComponent;
import com.ezwel.admin.domain.entity.common.Manager;
import com.ezwel.admin.service.mgr.MgrCounselService;
import com.ezwel.admin.service.mgr.MgrService;
import com.ezwel.admin.service.mgr.dto.MgrCertDto;
import com.ezwel.admin.service.mgr.dto.MgrDto;
import com.ezwel.admin.service.mgr.dto.MgrSubDto;
import com.ezwel.admin.service.security.UserDetailsHelper;
import com.ezwel.core.support.util.Base64Utils;
import com.ezwel.core.support.util.StringUtils;

@Controller
@RequestMapping("/partner/mgr")
public class CadmMgrController {
	private static Logger log = LoggerFactory.getLogger(CadmMgrController.class);
	@Resource
	private MgrService mgrService;

	@Resource
	private MgrCounselService mgrCounselService;
	
	@Resource
	EncryptComponent encryptComponent;
	
	private void setMenu(Model model) {
		String menuStr = "상담사관리";
		model.addAttribute("menu", menuStr);
	}


	@RequestMapping(value = "/modifyMyInformation")
	public String myImformation(@ModelAttribute MgrDto mgrDto, @ModelAttribute MgrSubDto mgrSubDto, @ModelAttribute MgrCertDto mgrCertDto, Model model, HttpServletRequest request ) {
		Manager manager = UserDetailsHelper.getAuthenticatedUser();

		mgrDto.setUserId( Base64Utils.encode(StringUtils.defaultString(manager.getUserId())));
		
		setMenu(model);
		model.addAttribute("mgr", mgrService.getMgrSelectOne(mgrDto));

		mgrSubDto.setUserId(mgrDto.getUserId());
		mgrCertDto.setUserId(mgrDto.getUserId());

		model.addAttribute("mgrSub", mgrCounselService.getMgrSelectOne(mgrSubDto));

		model.addAttribute("mgrCert", mgrCounselService.getMgrCertList(mgrCertDto));
		model.addAttribute("mgrCertCnt", mgrCounselService.getMgrCertList(mgrCertDto).size());
		
		if("Y".equals(manager.getImsiPwdYn())){
			model.addAttribute("redirectNo", "Y");
		}
		
		String alertYn = (String) request.getParameter("alertYn");
		if("Y".equals(alertYn)){
			model.addAttribute("alertMsg", " 개인정보를 변경 하였습니다. \\n임시비밀번호를 변경하였을 경우 재로그인 해주세요.");
		}
		
		return "partner/mgr/modifyMyInformation";
	}

	@RequestMapping(value="/update")
	public String updateMyInformation(@ModelAttribute MgrDto mgrDto, @ModelAttribute MgrSubDto mgrSubDto, @ModelAttribute MgrCertDto mgrCertDto, Model model, HttpServletRequest request,
			MultipartHttpServletRequest mhsq) throws Exception{
		setMenu(model);
		mgrCertDto.init(mhsq, true);
		
		Manager manager = UserDetailsHelper.getAuthenticatedUser();
		mgrDto.setUserId(manager.getUserId());
		mgrSubDto.setUserId(manager.getUserId());
		mgrDto.setCenterOwnerYn(manager.getCenterOwnerYn());
		if(request.getParameter("delPhoto").equals("")){
		}else{
			mgrSubDto.setFileNm(" ");
			mgrSubDto.setFilePath(" ");
		}
		if(StringUtils.isNotNull(mgrDto.getUserPwd())){
			mgrDto.setUserPwd(encryptComponent.encode(mgrDto.getUserPwd()));
		}
		mgrCounselService.modifyMyinfoMgr(mgrDto, mgrSubDto, mgrCertDto, request);
		
		model.addAttribute("alertYn", "Y");
		
		return "redirect:/partner/mgr/modifyMyInformation";
	}

}
